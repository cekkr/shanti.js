<script>
    if (typeof module === 'object') {
        window.module = module;
        module = undefined;
    }

</script>

<!DOCTYPE html>
<html> 
  <head>
    <title>Photon</title>

    <script>  
        const { BrowserWindow } = require('electron').remote;
        const { ipcRenderer } = require('electron');      
        
        var thisWin = BrowserWindow.getFocusedWindow();
        var processVars = require('electron').remote.getGlobal('processVars');
        
        ///
        /// Load resources manager
        ///
        /*
            !!! Currently unused !!!
            In the ServiceWorker resources_manager.js during a respondWith() maybe for waitUntil function
            is not possible send (and consequently receive) messages in the BroadcastChannel.
            For this reason, for the moment, is not possible a dynamic transfer of resources directly from
            the parent process without passing through TCP layers. 
        */
        
        // Thanks to https://stackoverflow.com/questions/26516358/intercept-browser-requests-for-resources
        if (false && 'serviceWorker' in navigator) { 
            const channelRM = new BroadcastChannel('rm-messages');

            if (!navigator.serviceWorker.controller) 
              console.log("This page is not controlled by a ServiceWorker");
            else 
              console.log("This page is controlled by a ServiceWorker");

            var serviceWorker = false;

            function createServiceWorker(){
                console.log('trying to creating resource manager...');

                navigator.serviceWorker.register('resources_manager.js', {updateViaCache: 'none'})
                .then(function(registration){
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    
                    serviceWorker = registration.active;
                    //window.location.reload(true);
                },
                function(err) { // registration failed :( 
                    console.log('ServiceWorker registration failed: ', err); 
                }); 
            }
            
            navigator.serviceWorker.getRegistration().then(function(reg) {
                if(reg){
                    serviceWorker = reg.active;
                    console.log('there is reg');
                    
                    function showWaitingMessage() {
                        console.log("A new ServiceWorker is waiting to become active. It can't become active now because pages are still open that are controlled by the older version. Either close those tabs, or shift+reload them (which loads them without the ServiceWorker). That will allow the new version to become active, so it'll be used for the next page load.");
                    }

                    //reg.unregister();

                    reg.addEventListener('updatefound', function() {
                        console.log("Found a new ServiceWorker!");
                        var installing = reg.installing;
                        reg.installing.addEventListener('statechange', function() {
                          if (installing.state == 'installed') {
                            console.log("New ServiceWorker installed.");
                            // give it a second to see if it activates immediately
                            setTimeout(function() {
                              if (installing.state == 'activated') {
                                console.log("New ServiceWorker activated! Reload to load this page with the new ServiceWorker.");
                              }
                              else {
                                showWaitingMessage();
                              }
                            }, 1000);
                          }
                          else if (installing.state == 'redundant') {
                            console.log("The new worker failed to install - likely an error during install");
                          }
                        });
                    });

                    if (reg.waiting) {
                        showWaitingMessage();
                    }
                }
                else 
                    createServiceWorker();
            });
            
            channelRM.addEventListener('message', (event) => {
                var d = event.data;

                console.log('Received message about', d);
                if(d.dest == 'p')
                    ipcRenderer.send('resource-manager', d);
            });

            ipcRenderer.on('resource-manager', function (event, arg) {
                if(arg.dest == 'rm')
                    channelRM.postMessage(arg);   
            });
            
        } 
        
        
    </script>
      
    <style>
        .titlebar {
            /* Makes topbar moveable */
            -webkit-user-select: none;
            -webkit-app-region: drag;
        }
    </style>
      
    <!-- Stylesheets -->
    <link rel="stylesheet" href="vendors/photon/dist/css/photon.css">
    <!--<script src="test3.ejs.js"></script>-->
      
    <!-- Scripts -->
    <script src="vendors/jquery-ui/external/jquery/jquery.js"></script>
      
    <style>
        .demo-app-container{height:200px; width: 200px; border-radius:6px;overflow:hidden;box-shadow:0 0 60px rgba(0,0,0,.3)};    
    </style>
      
  </head>
  <body>
    <div class="window">
        <header class="toolbar toolbar-header titlebar">
            <h1 class="title">Example</h1>
        </header>
        <div class="window-content">
            empty
        </div>
    </div>
  </body>
</html>

    <script>
        /*$(document).ready(function(){
           console.log('all done'); 
        });*/
    </script>
